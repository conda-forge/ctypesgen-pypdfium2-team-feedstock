From 069d589653bb82bdbe24423a03dbf0b15cc75743 Mon Sep 17 00:00:00 2001
From: Jan Janssen <jan-janssen@users.noreply.github.com>
Date: Thu, 11 Jul 2024 17:12:37 +0200
Subject: [PATCH] Patch gcc

---
 src/ctypesgen/__main__.py | 4 +++-
 tests/conftest.py         | 2 +-
 tests/testsuite.py        | 4 ++--
 3 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/src/ctypesgen/__main__.py b/src/ctypesgen/__main__.py
index d2c8c20..a4d6b7b 100644
--- a/src/ctypesgen/__main__.py
+++ b/src/ctypesgen/__main__.py
@@ -1,3 +1,4 @@
+import os
 import re
 import sys
 import shlex
@@ -90,6 +91,8 @@ def main_impl(args, cmd_str):
     if args.cpp:
         assert shutil.which(args.cpp[0]), f"Given pre-processor {args.cpp[0]!r} is not available."
     else:
-        if shutil.which("gcc"):
+        if "CC" in os.environ:
+            args.cpp = [os.environ["CC"], "-E"]
+        elif shutil.which("gcc"):
             args.cpp = ["gcc", "-E"]
         elif shutil.which("cpp"):
diff --git a/tests/conftest.py b/tests/conftest.py
index c77ca3a..b1e4f5a 100644
--- a/tests/conftest.py
+++ b/tests/conftest.py
@@ -19,7 +19,7 @@ TMP_DIR = TEST_DIR/"tmp"

 CLEANUP_OK = bool(int(os.environ.get("CLEANUP_OK", "1")))
 MAIN_CPP = os.environ.get("CPP", None)
-COMPILER = "gcc"
+COMPILER = os.environ.get("CC", "gcc")

 CTG_LIBPATTERN = "{prefix}{name}.{suffix}"

diff --git a/tests/testsuite.py b/tests/testsuite.py
index 1234567..abcdefg 100644
--- a/tests/testsuite.py
+++ b/tests/testsuite.py
@@ -1135,11 +1135,11 @@ class DefUndefTest(unittest.TestCase):

     def test_default_undef(self):
         # this actually works because the def/undef are taken over into the output, so we won't get a "no target members" exception.
-        m = generate("", ["--symbol-rules", "yes=__GNUC__"], cpp=f"gcc -E", allow_gnuc=False)
+        m = generate("", ["--symbol-rules", "yes=__GNUC__"], cpp=f"{os.environ.get('CC', 'gcc')} -E", allow_gnuc=False)
         self.assertFalse(hasattr(m, "__GNUC__"))

     def test_override_default_undef(self):
-        m = generate("", ["--symbol-rules", "yes=__GNUC__"], cpp=f"gcc -E", allow_gnuc=True)
+        m = generate("", ["--symbol-rules", "yes=__GNUC__"], cpp=f"{os.environ.get('CC', 'gcc')} -E", allow_gnuc=True)
         self.assertIsInstance(m.__GNUC__, int)  # this will be the GCC major version

     def test_default_def(self):
